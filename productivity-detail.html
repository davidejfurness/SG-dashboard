<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity & Finance - Shelford Group Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root { --shelford-teal: #007B7F; --shelford-dark-teal: #005A5D; --shelford-sage: #5B7F6C; --shelford-cream: #FDFBF7; --text-dark: #1A1A1A; --text-mid: #4A4A4A; --border-light: #E5E5E5; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--shelford-cream); color: var(--text-dark); line-height: 1.6; padding: 2rem; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 3px solid var(--shelford-teal); }
        .logo-link { display: inline-block; } .logo { width: 120px; height: auto; }
        h1 { font-size: 2.5rem; color: var(--shelford-dark-teal); font-weight: 700; }
        .subtitle { font-size: 1.1rem; color: var(--text-mid); margin-top: 0.5rem; }
        h2 { font-size: 1.8rem; color: var(--shelford-dark-teal); margin: 3rem 0 1rem 0; font-weight: 600; }
        h3 { font-size: 1.3rem; color: var(--shelford-dark-teal); margin: 1rem 0; }
        .source-note { font-size: 0.9rem; color: var(--text-mid); margin-top: 0.5rem; margin-bottom: 1.5rem; font-style: italic; }
        nav { background: white; padding: 1rem 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,123,127,0.08); }
        nav a { color: var(--shelford-teal); text-decoration: none; font-weight: 500; padding: 0.5rem 1rem; transition: all 0.2s; display: inline-block; }
        nav a:hover { background: rgba(0,123,127,0.1); border-radius: 6px; }
        nav a.active { color: var(--shelford-dark-teal); background: rgba(0,123,127,0.1); border-radius: 6px; font-weight: 600; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
        .metric-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,123,127,0.08); border-left: 4px solid var(--shelford-teal); }
        .metric-label { font-size: 0.9rem; color: var(--text-mid); margin-bottom: 0.5rem; font-weight: 500; }
        .metric-value { font-size: 2.5rem; color: var(--shelford-dark-teal); font-weight: 700; margin-bottom: 0.25rem; }
        .metric-value.positive { color: #059669; }
        .metric-benchmark { font-size: 0.85rem; color: var(--text-mid); }
        .info-box { background: rgba(0,123,127,0.05); border-left: 3px solid var(--shelford-teal); padding: 1rem 1.5rem; border-radius: 0 8px 8px 0; margin-bottom: 2rem; font-size: 0.95rem; color: var(--text-mid); }
        .info-box strong { color: var(--shelford-dark-teal); }
        .table-container { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,123,127,0.08); margin-bottom: 3rem; overflow-x: auto; }
        .sort-buttons { margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .sort-btn { padding: 0.5rem 1rem; background: var(--shelford-teal); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
        .sort-btn:hover { background: var(--shelford-dark-teal); } .sort-btn.active { background: var(--shelford-dark-teal); }
        table { width: 100%; border-collapse: collapse; } thead { background: var(--shelford-teal); color: white; }
        th { padding: 1rem; text-align: left; font-weight: 600; } td { padding: 1rem; border-bottom: 1px solid var(--border-light); }
        tbody tr:hover { background: rgba(0,123,127,0.05); } .trust-name { font-weight: 500; }
        .positive { color: #059669; } .negative { color: #DC2626; }
        .chart-container { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,123,127,0.08); margin-bottom: 3rem; }
        .chart-wrapper { position: relative; height: 400px; margin-top: 1rem; }
        .chart-controls { margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .chart-btn { padding: 0.5rem 1rem; background: var(--shelford-teal); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
        .chart-btn:hover { background: var(--shelford-dark-teal); }
        .data-note { background: #FEF3C7; border-left: 3px solid #F59E0B; padding: 1rem 1.5rem; border-radius: 0 8px 8px 0; margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-mid); }
        footer { margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--border-light); text-align: center; color: var(--text-mid); font-size: 0.9rem; }
        @media (max-width: 768px) { body { padding: 1rem; } h1 { font-size: 1.8rem; } .metric-value { font-size: 2rem; } .chart-wrapper { height: 300px; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="logo-link"><img src="shelford-logo.jpg" alt="Shelford Group" class="logo"></a>
            <div><h1>NHS Productivity & Finance</h1><p class="subtitle">Trust-level productivity growth estimates and in-year financial positions</p></div>
        </header>
        <nav><div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
            <a href="index.html">Overview</a><a href="rtt-detail.html">RTT & Elective Care</a><a href="ae-detail.html">A&E & Urgent Care</a><a href="cancer-detail.html">Cancer Services</a><a href="quality-detail.html">Patient Safety & Quality</a><a href="capacity-detail.html">Capacity & Beds</a><a href="workforce-detail.html">Workforce</a><a href="research-detail.html">Research & Clinical Trials</a><a href="productivity-detail.html" class="active">Productivity & Finance</a>
        </div></nav>

        <div class="info-box">
            <strong>About this measure:</strong> This is the new NHS England trust-level productivity growth estimate, first published 12 February 2026. It compares cost-weighted activity growth (outputs) with real-terms resource growth (inputs). The Spending Review 2025 sets a target of <strong>2% year-on-year productivity growth</strong>, with the aim of returning to pre-pandemic productivity levels by the end of the parliament. Figures are year-to-date (YTD), comparing April–October 2025 with the same period in 2024/25. This is experimental management information — see the <a href="https://www.england.nhs.uk/long-read/nhs-productivity-growth-estimate-2025-26-methodology/" style="color: var(--shelford-teal);">full methodology</a>.
        </div>

        <div class="data-note">
            <strong>Interpretation note:</strong> These estimates are provisional and subject to revision as trusts restate activity data. Sheffield's early-month figures show high volatility likely reflecting data restatement effects. The October YTD figure (the most complete) is the most reliable for each trust.
        </div>

        <h2>Headline Productivity – October 2025 YTD</h2>
        <p class="source-note">Source: NHS England Productivity Growth Estimate, April–October 2025 (published 12 February 2026)</p>
        <div class="dashboard-grid">
            <div class="metric-card"><div class="metric-label">Shelford Group Average</div><div class="metric-value positive">+4.5%</div><div class="metric-benchmark">Productivity growth, Apr–Oct 2025 YTD</div></div>
            <div class="metric-card"><div class="metric-label">England Average</div><div class="metric-value positive">+3.5%</div><div class="metric-benchmark">All NHS providers, same period</div></div>
            <div class="metric-card"><div class="metric-label">Spending Review Target</div><div class="metric-value">2.0%</div><div class="metric-benchmark">Year-on-year target from SR25</div></div>
            <div class="metric-card"><div class="metric-label">Acute & Specialist (National)</div><div class="metric-value positive">+2.8%</div><div class="metric-benchmark">Provider type benchmark</div></div>
        </div>

        <h2>Trust-Level Productivity Growth</h2>
        <p class="source-note">Source: NHS England Productivity Growth Estimate, October 2025 YTD (published 12 February 2026). All figures are provisional.</p>
        <div class="table-container">
            <div class="sort-buttons">
                <button class="sort-btn active" onclick="sortTable('alpha', event)">A-Z</button>
                <button class="sort-btn" onclick="sortTable('productivity', event)">Productivity</button>
                <button class="sort-btn" onclick="sortTable('output', event)">Output Growth</button>
                <button class="sort-btn" onclick="sortTable('input', event)">Input Growth</button>
            </div>
            <table>
                <thead><tr><th>Trust</th><th>Productivity Growth</th><th>Output Growth (CWA)</th><th>Input Growth (Resource)</th></tr></thead>
                <tbody id="prodTableBody"></tbody>
            </table>
        </div>

        <div class="chart-container">
            <h3>Productivity Growth by Trust – October 2025 YTD</h3>
            <p class="source-note">Source: NHS England Productivity Growth Estimate. Dashed line = 2% Spending Review target. England average = 3.5%.</p>
            <div class="chart-controls">
                <button class="chart-btn" onclick="sortProdChart('alpha')">A-Z</button>
                <button class="chart-btn" onclick="sortProdChart('highest')">Highest to Lowest</button>
                <button class="chart-btn" onclick="sortProdChart('lowest')">Lowest to Highest</button>
            </div>
            <div class="chart-wrapper"><canvas id="prodChart"></canvas></div>
        </div>

        <div class="chart-container">
            <h3>Output Growth vs Input Growth – October 2025 YTD</h3>
            <p class="source-note">Source: NHS England Productivity Growth Estimate. Productivity is positive when the teal bar (output) exceeds the grey bar (input). All Shelford trusts show output exceeding input.</p>
            <div class="chart-controls">
                <button class="chart-btn" onclick="sortIOChart('alpha')">A-Z</button>
                <button class="chart-btn" onclick="sortIOChart('productivity')">Sort by Productivity</button>
            </div>
            <div class="chart-wrapper"><canvas id="ioChart"></canvas></div>
        </div>

        <div class="chart-container">
            <h3>Productivity Growth Trends – April to October 2025 (YTD)</h3>
            <p class="source-note">Source: NHS England Productivity Growth Estimate. Each point shows the cumulative YTD figure as at that month. Lines converge as YTD periods lengthen.</p>
            <div class="chart-wrapper" style="height: 450px;"><canvas id="trendChart"></canvas></div>
        </div>

        <!-- ===== FINANCE SECTION ===== -->
        <div style="border-top: 3px solid var(--shelford-teal); margin-top: 4rem; padding-top: 2rem;">
        <h2>Financial Position – 2025/26</h2>
        <p class="source-note">Source: Shelford Group CFO Monthly Updates, M9 YTD (December 2025). Figures are provider surplus/(deficit) in £000s. Manchester data incomplete and excluded from some charts.</p>

        <!-- YTD Position Bar Chart -->
        <div class="chart-container">
            <h3>M9 YTD Surplus / (Deficit) – Actual vs Plan</h3>
            <p class="source-note">Source: Shelford CFO Monthly Updates, December 2025. All figures £000s.</p>
            <div class="chart-controls">
                <button class="sort-btn" onclick="sortFinPos('alpha')">A-Z</button>
                <button class="sort-btn" onclick="sortFinPos('highest')">Highest to Lowest</button>
                <button class="sort-btn" onclick="sortFinPos('lowest')">Lowest to Highest</button>
            </div>
            <div class="chart-wrapper"><canvas id="finPosChart"></canvas></div>
        </div>

        <!-- Monthly Trajectory -->
        <div class="chart-container">
            <h3>YTD Financial Position Trajectory</h3>
            <p class="source-note">Source: Shelford CFO Monthly Updates. Each point shows cumulative YTD surplus/(deficit) in £000s. Months with missing data are omitted per trust.</p>
            <div style="margin-bottom:1rem; display:flex; gap:0.5rem; flex-wrap:wrap;" id="finTrustBtns"></div>
            <div class="chart-wrapper" style="height:450px;"><canvas id="finTrajectoryChart"></canvas></div>
        </div>

        <!-- CIP Delivery -->
        <div class="chart-container">
            <h3>CIP Delivery – M9 YTD Plan vs Actual</h3>
            <p class="source-note">Source: Shelford CFO Monthly Updates, December 2025. CIP = Cost Improvement Programme. £000s.</p>
            <div class="chart-controls">
                <button class="sort-btn" onclick="sortCIPChart('alpha')">A-Z</button>
                <button class="sort-btn" onclick="sortCIPChart('gap')">Largest Gap</button>
            </div>
            <div class="chart-wrapper"><canvas id="cipChart"></canvas></div>
        </div>

        <!-- Finance Summary Table -->
        <div class="table-container">
            <h3>Financial Summary</h3>
            <div class="chart-controls">
                <button class="sort-btn" onclick="sortFinTable('alpha')">A-Z</button>
                <button class="sort-btn" onclick="sortFinTable('m9Actual')">M9 YTD Actual</button>
                <button class="sort-btn" onclick="sortFinTable('m9Var')">Variance</button>
                <button class="sort-btn" onclick="sortFinTable('cipVar')">CIP Variance</button>
            </div>
            <table>
                <thead><tr><th>Trust</th><th>24/25 Outturn</th><th>25/26 FY Plan</th><th>M9 YTD Plan</th><th>M9 YTD Actual</th><th>Variance</th><th>CIP Target %</th><th>CIP Plan</th><th>CIP Actual</th><th>CIP Var</th></tr></thead>
                <tbody id="finTableBody"></tbody>
            </table>
        </div>
        </div>

        <footer><p>&copy; 2026 Shelford Group | Data updated February 2026</p></footer>
    </div>

    <script>
        const prodData = [
            { name: 'Birmingham', prod: 3.5, output: 4.6, input: 1.1, trend: [-0.1,4.5,4.1,4.4,4.1,4.5,3.5] },
            { name: 'Cambridge', prod: 4.1, output: 2.9, input: -1.2, trend: [1.7,2.6,4.8,3.6,3.9,7.2,4.1] },
            { name: 'GSTT', prod: 7.2, output: 7.1, input: 0.0, trend: [10.8,6.6,8.5,12.2,8.1,7.3,7.2] },
            { name: 'Imperial', prod: 3.4, output: 1.8, input: -1.5, trend: [4.3,3.3,1.8,2.9,2.5,3.5,3.4] },
            { name: "King's", prod: 5.5, output: 5.7, input: 0.2, trend: [4.4,3.3,4.6,4.2,4.7,5.0,5.5] },
            { name: 'Manchester', prod: 4.4, output: 4.3, input: -0.1, trend: [7.5,7.8,5.2,4.8,3.5,2.8,4.4] },
            { name: 'Newcastle', prod: 0.6, output: 1.9, input: 1.3, trend: [4.1,3.2,3.1,-1.3,4.0,-0.4,0.6] },
            { name: 'Oxford', prod: 3.2, output: 2.8, input: -0.4, trend: [4.7,4.5,2.3,3.0,3.2,3.7,3.2] },
            { name: 'Sheffield', prod: 2.3, output: 1.2, input: -1.1, trend: [19.1,15.3,15.6,4.0,3.1,2.3,2.3] },
            { name: 'UCLH', prod: 10.9, output: 12.7, input: 1.6, trend: [7.9,8.5,4.4,4.1,3.0,2.5,10.9] }
        ];
        const months = ['Apr','May','Jun','Jul','Aug','Sep','Oct'];
        const englandTrend = [3.4,2.8,3.0,3.1,3.2,3.6,3.5];

        function fmtPct(v) {
            const cls = v >= 0 ? 'positive' : 'negative';
            return `<span class="${cls}">${v >= 0 ? '+' : ''}${v.toFixed(1)}%</span>`;
        }

        function sortTable(field, e) {
            let sorted = [...prodData];
            if (field === 'productivity') sorted.sort((a, b) => b.prod - a.prod);
            else if (field === 'output') sorted.sort((a, b) => b.output - a.output);
            else if (field === 'input') sorted.sort((a, b) => a.input - b.input);
            document.getElementById('prodTableBody').innerHTML = sorted.map(t =>
                `<tr><td class="trust-name">${t.name}</td><td>${fmtPct(t.prod)}</td><td>${fmtPct(t.output)}</td><td>${fmtPct(t.input)}</td></tr>`
            ).join('');
            if (e) { document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); }
        }
        sortTable('alpha', null);

        // Productivity bar chart
        const prodChartData = { labels: prodData.map(d => d.name), values: prodData.map(d => d.prod) };
        let prodChart = new Chart(document.getElementById('prodChart'), {
            type: 'bar',
            data: {
                labels: [...prodChartData.labels],
                datasets: [{
                    label: 'Productivity Growth %',
                    data: [...prodChartData.values],
                    backgroundColor: '#007B7F',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { callback: v => (v >= 0 ? '+' : '') + v + '%' } } }
            },
            plugins: [{
                id: 'targetLines',
                afterDraw(chart) {
                    const ctx = chart.ctx, yScale = chart.scales.y;
                    // 2% target
                    let y = yScale.getPixelForValue(2);
                    ctx.save(); ctx.strokeStyle = '#EF4444'; ctx.lineWidth = 2; ctx.setLineDash([6,4]);
                    ctx.beginPath(); ctx.moveTo(chart.chartArea.left, y); ctx.lineTo(chart.chartArea.right, y); ctx.stroke();
                    ctx.fillStyle = '#EF4444'; ctx.font = '11px -apple-system, sans-serif';
                    ctx.fillText('SR25 Target: 2%', chart.chartArea.left + 5, y - 8);
                    // England avg
                    y = yScale.getPixelForValue(3.5);
                    ctx.strokeStyle = '#6B7280'; ctx.setLineDash([3,3]);
                    ctx.beginPath(); ctx.moveTo(chart.chartArea.left, y); ctx.lineTo(chart.chartArea.right, y); ctx.stroke();
                    ctx.fillStyle = '#6B7280';
                    ctx.fillText('England: 3.5%', chart.chartArea.right - 85, y - 8);
                    ctx.restore();
                }
            }]
        });
        function sortProdChart(type) {
            let indices = prodChartData.labels.map((_, i) => i);
            if (type === 'highest') indices.sort((a, b) => prodChartData.values[b] - prodChartData.values[a]);
            else if (type === 'lowest') indices.sort((a, b) => prodChartData.values[a] - prodChartData.values[b]);
            prodChart.data.labels = indices.map(i => prodChartData.labels[i]);
            prodChart.data.datasets[0].data = indices.map(i => prodChartData.values[i]);
            prodChart.update();
        }

        // Output vs Input grouped bar
        const ioData = { labels: prodData.map(d => d.name), outputs: prodData.map(d => d.output), inputs: prodData.map(d => d.input) };
        let ioChart = new Chart(document.getElementById('ioChart'), {
            type: 'bar',
            data: {
                labels: [...ioData.labels],
                datasets: [
                    { label: 'Output Growth (CWA)', data: [...ioData.outputs], backgroundColor: '#007B7F', borderRadius: 6 },
                    { label: 'Input Growth (Resource)', data: [...ioData.inputs], backgroundColor: '#CBD5E1', borderRadius: 6 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: { y: { ticks: { callback: v => (v >= 0 ? '+' : '') + v + '%' } } }
            }
        });
        function sortIOChart(type) {
            let indices = ioData.labels.map((_, i) => i);
            if (type === 'productivity') indices.sort((a, b) => prodData[b].prod - prodData[a].prod);
            ioChart.data.labels = indices.map(i => ioData.labels[i]);
            ioChart.data.datasets[0].data = indices.map(i => ioData.outputs[i]);
            ioChart.data.datasets[1].data = indices.map(i => ioData.inputs[i]);
            ioChart.update();
        }

        // Trend line chart
        const trendColors = ['#007B7F','#059669','#2563EB','#7C3AED','#DB2777','#EA580C','#0891B2','#4F46E5','#CA8A04','#DC2626'];
        new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    ...prodData.map((d, i) => ({
                        label: d.name, data: d.trend, borderColor: trendColors[i],
                        backgroundColor: 'transparent', tension: 0.3, borderWidth: 2, pointRadius: 3
                    })),
                    {
                        label: 'England', data: englandTrend, borderColor: '#1A1A1A',
                        backgroundColor: 'transparent', borderWidth: 3, borderDash: [6,3], pointRadius: 0, tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } },
                scales: { y: { ticks: { callback: v => (v >= 0 ? '+' : '') + v + '%' } } }
            }
        });

        // ===== FINANCE SECTION =====
        const finData = [
            { name: 'Birmingham', outturn24: -30700, fyPlan: -4200, m9Plan: -11187, m9Actual: -36766, m9Var: -25579, cipPct: 5.0, cipPlan: 92452, cipActual: 84876, cipVar: -7576,
              trend: [{m:'M1',v:-8600},{m:'M2',v:-14000},{m:'M3',v:-18807},{m:'M4',v:-21473},{m:'M5',v:-12700},{m:'M6',v:-27841},{m:'M7',v:-31216},{m:'M8',v:-36941},{m:'M9',v:-36766}] },
            { name: 'Cambridge', outturn24: 0, fyPlan: 0, m9Plan: -2929, m9Actual: 1430, m9Var: 4359, cipPct: 5.8, cipPlan: 67005, cipActual: 68228, cipVar: 1223,
              trend: [{m:'M1',v:-2071},{m:'M2',v:-2800},{m:'M3',v:100},{m:'M4',v:-1500},{m:'M5',v:-1600},{m:'M6',v:-500},{m:'M8',v:11},{m:'M9',v:1430}] },
            { name: 'GSTT', outturn24: 12682, fyPlan: 0, m9Plan: -25152, m9Actual: -25071, m9Var: 81, cipPct: 5.0, cipPlan: 55685, cipActual: 53411, cipVar: -2274,
              trend: [{m:'M1',v:-9990},{m:'M2',v:-17388},{m:'M3',v:-22944},{m:'M4',v:-23102},{m:'M5',v:-23062},{m:'M6',v:-23990},{m:'M7',v:-27147},{m:'M8',v:-29015},{m:'M9',v:-25071}] },
            { name: 'Imperial', outturn24: null, fyPlan: 0, m9Plan: 0, m9Actual: 10, m9Var: 10, cipPct: 4.3, cipPlan: 60024, cipActual: 59489, cipVar: -535,
              trend: [{m:'M1',v:-597},{m:'M2',v:-701},{m:'M3',v:1298},{m:'M4',v:-1141},{m:'M5',v:434},{m:'M6',v:771},{m:'M7',v:-669},{m:'M8',v:-1589},{m:'M9',v:10}] },
            { name: "King's", outturn24: -33700, fyPlan: 0, m9Plan: 705, m9Actual: 3255, m9Var: 2550, cipPct: 4.4, cipPlan: 51552, cipActual: 41901, cipVar: -9651,
              trend: [{m:'M1',v:-3035},{m:'M2',v:-1216},{m:'M3',v:-1465},{m:'M4',v:-1461},{m:'M5',v:50},{m:'M6',v:-112},{m:'M7',v:-573},{m:'M8',v:1983},{m:'M9',v:3255}] },
            { name: 'Manchester', outturn24: 3641, fyPlan: 0, m9Plan: null, m9Actual: null, m9Var: null, cipPct: 5.2, cipPlan: null, cipActual: null, cipVar: null,
              trend: [{m:'M1',v:-8622},{m:'M2',v:-11293},{m:'M3',v:-7123},{m:'M7',v:15876},{m:'M8',v:1159}] },
            { name: 'Newcastle', outturn24: null, fyPlan: 0, m9Plan: -2852, m9Actual: -2748, m9Var: 104, cipPct: 6.2, cipPlan: 72034, cipActual: 72030, cipVar: -4,
              trend: [{m:'M1',v:-5052},{m:'M2',v:-8012},{m:'M3',v:-8031},{m:'M4',v:-5379},{m:'M6',v:-4294},{m:'M7',v:956},{m:'M8',v:-578},{m:'M9',v:-2748}] },
            { name: 'Oxford', outturn24: -6794, fyPlan: 2000, m9Plan: 1100, m9Actual: 1100, m9Var: 0, cipPct: 5.6, cipPlan: 69500, cipActual: 61700, cipVar: -7800,
              trend: [{m:'M1',v:-3474},{m:'M2',v:-6507},{m:'M3',v:-8200},{m:'M4',v:-9200},{m:'M5',v:-9900},{m:'M6',v:-6696},{m:'M7',v:-6549},{m:'M8',v:-5429},{m:'M9',v:1100}] },
            { name: 'Sheffield', outturn24: 6926, fyPlan: 0, m9Plan: -475, m9Actual: -436, m9Var: 39, cipPct: 4.5, cipPlan: 60100, cipActual: 60100, cipVar: 0,
              trend: [{m:'M1',v:-1109},{m:'M2',v:-5665},{m:'M3',v:-6115},{m:'M4',v:-2868},{m:'M5',v:-3454},{m:'M6',v:-2659},{m:'M7',v:-1525},{m:'M8',v:-1511},{m:'M9',v:-436}] },
            { name: 'UCLH', outturn24: 17912, fyPlan: 12029, m9Plan: -7412, m9Actual: -6444, m9Var: 968, cipPct: 4.3, cipPlan: 52200, cipActual: 47516, cipVar: -4684,
              trend: [{m:'M1',v:-6166},{m:'M2',v:-8498},{m:'M3',v:-9675},{m:'M4',v:-7477},{m:'M5',v:-8347},{m:'M6',v:-6646},{m:'M7',v:-4512},{m:'M8',v:-2949},{m:'M9',v:-6444}] }
        ];

        // YTD Position Chart
        const finWithM9 = finData.filter(d => d.m9Actual !== null);
        let finPosChart = new Chart(document.getElementById('finPosChart'), {
            type: 'bar',
            data: {
                labels: finWithM9.map(d => d.name),
                datasets: [
                    { label: 'M9 YTD Actual', data: finWithM9.map(d => d.m9Actual), backgroundColor: '#007B7F', borderRadius: 4 },
                    { label: 'M9 YTD Plan', data: finWithM9.map(d => d.m9Plan), type: 'bar', backgroundColor: 'rgba(100,116,139,0.25)', borderColor: '#64748B', borderWidth: 1, borderRadius: 4 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': \u00a3' + (ctx.raw/1000).toFixed(1) + 'm' } } },
                scales: { y: { ticks: { callback: v => '\u00a3' + (v/1000).toFixed(0) + 'm' } } }
            }
        });

        function sortFinPos(type) {
            let sorted = [...finWithM9];
            if (type === 'highest') sorted.sort((a,b) => b.m9Actual - a.m9Actual);
            else if (type === 'lowest') sorted.sort((a,b) => a.m9Actual - b.m9Actual);
            finPosChart.data.labels = sorted.map(d => d.name);
            finPosChart.data.datasets[0].data = sorted.map(d => d.m9Actual);
            finPosChart.data.datasets[1].data = sorted.map(d => d.m9Plan);
            finPosChart.update();
        }

        // Trajectory Chart
        const allMonths = ['M1','M2','M3','M4','M5','M6','M7','M8','M9'];
        const finColors = ['#DC2626','#059669','#2563EB','#7C3AED','#DB2777','#EA580C','#0891B2','#4F46E5','#CA8A04','#007B7F'];
        let finActive = new Set([0, 2, 4, 9]);

        const finBtnContainer = document.getElementById('finTrustBtns');
        finData.forEach((t, i) => {
            const btn = document.createElement('button');
            btn.className = 'sort-btn' + (finActive.has(i) ? ' active' : '');
            btn.textContent = t.name;
            btn.style.borderColor = finActive.has(i) ? finColors[i] : '#CBD5E1';
            btn.onclick = () => {
                if (finActive.has(i)) finActive.delete(i); else finActive.add(i);
                btn.classList.toggle('active');
                btn.style.borderColor = finActive.has(i) ? finColors[i] : '#CBD5E1';
                updateFinTrajectory();
            };
            finBtnContainer.appendChild(btn);
        });

        const finTrajectoryChart = new Chart(document.getElementById('finTrajectoryChart'), {
            type: 'line',
            data: { labels: allMonths, datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': \u00a3' + (ctx.raw/1000).toFixed(1) + 'm' } } },
                scales: { y: { ticks: { callback: v => '\u00a3' + (v/1000).toFixed(0) + 'm' } }, x: { title: { display: true, text: '2025/26 Month' } } },
                spanGaps: true
            }
        });

        function updateFinTrajectory() {
            finTrajectoryChart.data.datasets = [...finActive].sort().map(i => {
                const t = finData[i];
                const data = allMonths.map(m => { const pt = t.trend.find(p => p.m === m); return pt ? pt.v : null; });
                return { label: t.name, data, borderColor: finColors[i], backgroundColor: finColors[i] + '20', borderWidth: 2, pointRadius: 4, tension: 0.3, spanGaps: true };
            });
            finTrajectoryChart.update();
        }
        updateFinTrajectory();

        // CIP Chart
        const cipSource = finData.filter(d => d.cipPlan !== null);
        let cipChartInst = new Chart(document.getElementById('cipChart'), {
            type: 'bar',
            data: {
                labels: cipSource.map(d => d.name),
                datasets: [
                    { label: 'CIP Plan', data: cipSource.map(d => d.cipPlan), backgroundColor: '#94A3B8', borderRadius: 4 },
                    { label: 'CIP Actual', data: cipSource.map(d => d.cipActual), backgroundColor: '#007B7F', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': \u00a3' + (ctx.raw/1000).toFixed(1) + 'm' } } },
                scales: { y: { ticks: { callback: v => '\u00a3' + (v/1000).toFixed(0) + 'm' } } }
            }
        });

        function sortCIPChart(type) {
            let sorted = [...cipSource];
            if (type === 'gap') sorted.sort((a,b) => a.cipVar - b.cipVar);
            cipChartInst.data.labels = sorted.map(d => d.name);
            cipChartInst.data.datasets[0].data = sorted.map(d => d.cipPlan);
            cipChartInst.data.datasets[1].data = sorted.map(d => d.cipActual);
            cipChartInst.update();
        }

        // Finance Summary Table
        const fmt = v => { if (v === null) return '\u2014'; const m = v/1000; return (m < 0 ? '\u2212' : '') + '\u00a3' + Math.abs(m).toFixed(1) + 'm'; };
        let finTableSort = 'alpha';
        let finTableAsc = true;

        function renderFinTable(data) {
            document.getElementById('finTableBody').innerHTML = data.map(d => {
                return `<tr><td class="trust-name">${d.name}</td><td>${fmt(d.outturn24)}</td><td>${fmt(d.fyPlan)}</td><td>${fmt(d.m9Plan)}</td><td>${fmt(d.m9Actual)}</td><td>${fmt(d.m9Var)}</td><td>${d.cipPct}%</td><td>${fmt(d.cipPlan)}</td><td>${fmt(d.cipActual)}</td><td>${fmt(d.cipVar)}</td></tr>`;
            }).join('');
        }

        function sortFinTable(field) {
            if (field === finTableSort && field !== 'alpha') { finTableAsc = !finTableAsc; }
            else { finTableAsc = true; finTableSort = field; }
            let sorted = [...finData];
            if (field !== 'alpha') {
                sorted.sort((a, b) => {
                    const av = a[field] === null ? -Infinity : a[field];
                    const bv = b[field] === null ? -Infinity : b[field];
                    return finTableAsc ? av - bv : bv - av;
                });
            }
            renderFinTable(sorted);
        }
        renderFinTable(finData);
    </script>
</body>
</html>

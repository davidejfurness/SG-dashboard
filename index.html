<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelford Group Performance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --shelford-teal: #007B7F;
            --shelford-dark-teal: #005A5D;
            --shelford-sage: #5B7F6C;
            --shelford-cream: #FDFBF7;
            --text-dark: #1A1A1A;
            --text-mid: #4A4A4A;
            --border-light: #E5E5E5;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--shelford-cream); color: var(--text-dark); line-height: 1.6; padding: 2rem; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; align-items: center; gap: 2rem; margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 3px solid var(--shelford-teal); }
        .logo-link { display: inline-block; }
        .logo { width: 120px; height: auto; }
        h1 { font-size: 2.5rem; color: var(--shelford-dark-teal); font-weight: 700; }
        .subtitle { font-size: 1.1rem; color: var(--text-mid); margin-top: 0.5rem; }
        h2 { font-size: 1.8rem; color: var(--shelford-dark-teal); margin: 3rem 0 1rem 0; font-weight: 600; }
        .source-note { font-size: 0.9rem; color: var(--text-mid); margin-top: 0.5rem; margin-bottom: 1.5rem; font-style: italic; }
        nav { background: white; padding: 1rem 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,123,127,0.08); }
        nav div { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        nav a { color: var(--shelford-teal); text-decoration: none; font-weight: 500; padding: 0.5rem 1rem; transition: all 0.2s; display: inline-block; }
        nav a:hover { background: rgba(0,123,127,0.1); border-radius: 6px; }
        nav a.active { color: var(--shelford-dark-teal); background: rgba(0,123,127,0.1); border-radius: 6px; font-weight: 600; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
        .metric-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,123,127,0.08); border-left: 4px solid var(--shelford-teal); }
        .metric-label { font-size: 0.9rem; color: var(--text-mid); margin-bottom: 0.5rem; font-weight: 500; }
        .metric-value { font-size: 2.5rem; color: var(--shelford-dark-teal); font-weight: 700; margin-bottom: 0.25rem; }
        .metric-benchmark { font-size: 0.85rem; color: var(--text-mid); }
        .table-container { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,123,127,0.08); margin-bottom: 3rem; overflow-x: auto; }
        .sort-buttons { margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .sort-btn { padding: 0.5rem 1rem; background: var(--shelford-teal); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
        .sort-btn:hover { background: var(--shelford-dark-teal); }
        .sort-btn.active { background: var(--shelford-dark-teal); }
        .sort-arrow { font-size: 0.75rem; margin-left: 0.25rem; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--shelford-teal); color: white; }
        th { padding: 1rem; text-align: left; font-weight: 600; }
        td { padding: 1rem; border-bottom: 1px solid var(--border-light); }
        tbody tr:hover { background: rgba(0,123,127,0.05); }
        .trust-name { font-weight: 500; color: var(--text-dark); }
        .oversight-badge { padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .segment-1 { background: #E0F2F3; color: #005F63; }
        .segment-2 { background: #B2DFE2; color: #005F63; }
        .segment-3 { background: #6BBCC2; color: #FFFFFF; }
        .segment-4 { background: #007B7F; color: #FFFFFF; }
        .hm-1 { background: #E0F2F3; color: #005F63; font-weight: 600; text-align: center; }
        .hm-2 { background: #B2DFE2; color: #005F63; font-weight: 600; text-align: center; }
        .hm-3 { background: #6BBCC2; color: #FFFFFF; font-weight: 600; text-align: center; }
        .hm-4 { background: #007B7F; color: #FFFFFF; font-weight: 600; text-align: center; }
        .radar-btn { padding: 0.4rem 0.9rem; border-radius: 6px; border: 2px solid #CBD5E1; cursor: pointer; font-size: 0.85rem; background: white; transition: all 0.2s; }
        .radar-btn.active { border-color: var(--shelford-teal); background: rgba(0,123,127,0.1); font-weight: 600; }
        .chart-container { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,123,127,0.08); margin-bottom: 3rem; }
        .chart-wrapper { position: relative; height: 400px; margin-top: 1rem; }
        footer { margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--border-light); text-align: center; color: var(--text-mid); font-size: 0.9rem; }
        @media (max-width: 768px) { body { padding: 1rem; } h1 { font-size: 1.8rem; } .metric-value { font-size: 2rem; } }
    </style>
</head>
<body>
<!-- Access Gate -->
<div id="authGate" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#f8fafc;z-index:99999;font-family:-apple-system,BlinkMacSystemFont,sans-serif;">
<div style="max-width:400px;margin:15vh auto;text-align:center;padding:2rem;">
<div style="width:60px;height:60px;background:#007B7F;border-radius:12px;margin:0 auto 1.5rem;display:flex;align-items:center;justify-content:center;">
<svg width="30" height="30" fill="white" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/></svg>
</div>
<h2 style="color:#1E293B;margin-bottom:0.5rem;font-size:1.4rem;">Shelford Group Dashboard</h2>
<p style="color:#64748B;margin-bottom:1.5rem;font-size:0.95rem;">This dashboard is for Shelford Group colleagues only.</p>
<input id="authInput" type="password" placeholder="Enter access code" style="width:100%;padding:0.75rem 1rem;border:2px solid #CBD5E1;border-radius:8px;font-size:1rem;box-sizing:border-box;margin-bottom:0.75rem;outline:none;transition:border-color 0.2s;" onfocus="this.style.borderColor='#007B7F'" onblur="this.style.borderColor='#CBD5E1'">
<button onclick="checkAuth()" style="width:100%;padding:0.75rem;background:#007B7F;color:white;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#005f63'" onmouseout="this.style.background='#007B7F'">Continue</button>
<p id="authError" style="color:#DC2626;font-size:0.85rem;margin-top:0.75rem;display:none;">Incorrect access code. Please try again.</p>
<p style="color:#94A3AF;font-size:0.85rem;margin-top:1.5rem;">Contact <a href="mailto:info@shelfordgroup.org" style="color:#007B7F;">info@shelfordgroup.org</a> for the access code</p>
</div>
</div>
<script>
(function(){
var h="3ee9745bc638f7b38b2edccc974778cd262e0526469a3b724fcd680bdb7c984f";
function getCk(){var m=document.cookie.match(/sgAuth=([^;]+)/);return m?m[1]:null}
if(getCk()===h){document.getElementById("authGate").style.display="none";}
else{document.getElementById("authGate").style.display="block";document.body.style.overflow="hidden";
document.getElementById("authInput").addEventListener("keydown",function(e){if(e.key==="Enter")checkAuth();});}
window.checkAuth=async function(){
var v=document.getElementById("authInput").value.toLowerCase().trim();
var enc=new TextEncoder();var buf=await crypto.subtle.digest("SHA-256",enc.encode(v));
var arr=Array.from(new Uint8Array(buf));var hex=arr.map(function(b){return b.toString(16).padStart(2,"0")}).join("");
if(hex===h){var d=new Date();d.setTime(d.getTime()+365*24*60*60*1000);document.cookie="sgAuth="+h+";expires="+d.toUTCString()+";path=/";
document.getElementById("authGate").style.display="none";document.body.style.overflow="";}
else{document.getElementById("authError").style.display="block";document.getElementById("authInput").value="";document.getElementById("authInput").focus();}};
})();
</script>
<!-- End Access Gate -->
    <div class="container">
        <header>
            <a href="index.html" class="logo-link"><img src="shelford-logo.jpg" alt="Shelford Group" class="logo"></a>
            <div>
                <h1>Shelford Group Performance Dashboard</h1>
                <p class="subtitle">Working together to improve health and care</p>
            </div>
        </header>

        <nav><div>
            <a href="index.html" class="active">Overview</a>
            <a href="rtt-detail.html">RTT & Elective Care</a>
            <a href="ae-detail.html">A&E & Urgent Care</a>
            <a href="cancer-detail.html">Cancer Services</a>
            <a href="quality-detail.html">Patient Safety & Quality</a>
            <a href="capacity-detail.html">Capacity & Beds</a>
            <a href="workforce-detail.html">Workforce</a><a href="research-detail.html">Research &amp; Clinical Trials</a><a href="productivity-detail.html">Productivity &amp; Finance</a>
        </div></nav>

        <h2>Key Performance Indicators – Shelford Group Averages</h2>
        <p class="source-note">Source: A&amp;E from NHS England A&amp;E Attendances &amp; Emergency Admissions, January 2026. RTT and Cancer from NHS England, November 2025. Diagnostic from NHS England DM01, November 2025 (unverified). Figures are averages across all 10 Shelford Group trusts.</p>
        <div class="dashboard-grid">
            <div class="metric-card">
                <div class="metric-label">A&E 4-Hour Standard (Shelford Avg)</div>
                <div class="metric-value">71.0%</div>
                <div class="metric-benchmark">National average: 72.5% | NHS target: 95%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">RTT 18-Week Standard (Shelford Avg)</div>
                <div class="metric-value">62.8%</div>
                <div class="metric-benchmark">National average: 61.8% | NHS target: 92%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Cancer 62-Day Standard (Shelford Avg)</div>
                <div class="metric-value">68.3%</div>
                <div class="metric-benchmark">National average: 70.2% | NHS target: 85%</div>
            </div>
        </div>

        <h2>Trust Performance Comparison</h2>
        <p class="source-note">Source: A&amp;E from January 2026; RTT, Cancer and Diagnostic from November 2025. Diagnostic figures are unverified.</p>
        <div class="table-container">
            <div class="sort-buttons">
                <button class="sort-btn active" onclick="sortTable('alpha')">A-Z</button>
                <button class="sort-btn" onclick="sortTable('ae')">A&E <span class="sort-arrow">▼</span></button>
                <button class="sort-btn" onclick="sortTable('rtt')">RTT <span class="sort-arrow">▼</span></button>
                <button class="sort-btn" onclick="sortTable('cancer')">Cancer <span class="sort-arrow">▼</span></button>
            </div>
            <table>
                <thead><tr><th>Trust</th><th>A&E 4hr (%)</th><th>RTT 18wk (%)</th><th>Cancer 62d (%)</th></tr></thead>
                <tbody id="performanceTableBody"></tbody>
            </table>
        </div>

        <h2>NHS Oversight Framework – Q2 2025/26</h2>
        <p class="source-note">Source: NHS England Oversight Framework Acute Trust Data, Q2 2025/26. Segment 1 = highest performing, Segment 4 = requires most improvement. Scores range from 1 (best) to 4 (worst).</p>

        <!-- Overall Summary Table -->
        <div class="table-container">
            <h3>Overall Segmentation</h3>
            <table>
                <thead><tr><th>Trust</th><th>Segment</th><th>Overall Score</th></tr></thead>
                <tbody>
                    <tr><td class="trust-name">Imperial</td><td><span class="oversight-badge segment-1">Segment 1</span></td><td>1.76</td></tr>
                    <tr><td class="trust-name">GSTT</td><td><span class="oversight-badge segment-1">Segment 1</span></td><td>1.78</td></tr>
                    <tr><td class="trust-name">UCLH</td><td><span class="oversight-badge segment-1">Segment 1</span></td><td>1.79</td></tr>
                    <tr><td class="trust-name">Newcastle</td><td><span class="oversight-badge segment-2">Segment 2</span></td><td>2.19</td></tr>
                    <tr><td class="trust-name">Sheffield</td><td><span class="oversight-badge segment-2">Segment 2</span></td><td>2.33</td></tr>
                    <tr><td class="trust-name">Oxford</td><td><span class="oversight-badge segment-3">Segment 3</span></td><td>2.27</td></tr>
                    <tr><td class="trust-name">Cambridge</td><td><span class="oversight-badge segment-3">Segment 3</span></td><td>2.37</td></tr>
                    <tr><td class="trust-name">Manchester</td><td><span class="oversight-badge segment-3">Segment 3</span></td><td>2.50</td></tr>
                    <tr><td class="trust-name">King's</td><td><span class="oversight-badge segment-3">Segment 3</span></td><td>2.59</td></tr>
                    <tr><td class="trust-name">Birmingham</td><td><span class="oversight-badge segment-4">Segment 4</span></td><td>2.87</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Domain Heatmap -->
        <div class="table-container">
            <h3>Domain Segmentation Heatmap</h3>
            <p class="source-note" style="margin-top:-0.5rem">Each cell shows the domain segment (1–4). Lighter shading indicates stronger performance. Click any column header to sort.</p>
            <div class="sort-buttons" id="hmSortBtns">
                <button class="sort-btn active" onclick="sortHeatmap('alpha')">A-Z</button>
                <button class="sort-btn" onclick="sortHeatmap('overall')">Overall <span class="sort-arrow">▼</span></button>
                <button class="sort-btn" onclick="sortHeatmap('access')">Access <span class="sort-arrow">▼</span></button>
                <button class="sort-btn" onclick="sortHeatmap('effectiveness')">Effectiveness <span class="sort-arrow">▼</span></button>
                <button class="sort-btn" onclick="sortHeatmap('finance')">Finance <span class="sort-arrow">▼</span></button>
                <button class="sort-btn" onclick="sortHeatmap('safety')">Safety <span class="sort-arrow">▼</span></button>
                <button class="sort-btn" onclick="sortHeatmap('people')">People <span class="sort-arrow">▼</span></button>
            </div>
            <table id="heatmapTable">
                <thead><tr><th>Trust</th><th>Overall</th><th>Access</th><th>Effectiveness</th><th>Finance</th><th>Safety</th><th>People</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Domain Scores Radar -->
        <div class="chart-container">
            <h3>Domain Score Profiles</h3>
            <p class="source-note">Source: NHS England Oversight Framework Q2 2025/26. Lower scores = better performance. Select trusts to compare.</p>
            <div style="margin-bottom:1rem; display:flex; gap:0.5rem; flex-wrap:wrap;" id="radarBtns"></div>
            <div class="chart-wrapper"><canvas id="radarChart"></canvas></div>
        </div>

        <!-- Key Metrics vs National Benchmarks -->
        <div class="chart-container">
            <h3>National Ranking – Key Metrics</h3>
            <p class="source-note">Source: NHS England (various). RTT, A&amp;E, Cancer and FDS from Oversight Framework Q2 2025/26. Sickness from ESR November 2025. Staff engagement from NHS Staff Survey 2024. Median/quartile benchmarks from ~130 acute trusts. Note: NOF metric values are from Q2 2025/26 and may differ from the latest monthly figures shown elsewhere on this dashboard.</p>
            <div style="margin-bottom:1rem">
                <select id="metricSelector" style="padding:0.5rem 1rem; border-radius:6px; border:1px solid var(--border-light); font-size:0.95rem; min-width:300px;" onchange="updateMetricChart()">
                    <option value="rtt18">RTT 18-week % (higher = better)</option>
                    <option value="ae4hr">A&E 4-hour % (higher = better)</option>
                    <option value="ae12hr">A&E 12-hour % (lower = better)</option>
                    <option value="cancer62">Cancer 62-day % (higher = better)</option>
                    <option value="cancerfds">Cancer FDS 28-day % (higher = better)</option>
                    <option value="sickness">Sickness absence % (lower = better)</option>
                    <option value="engagement">Staff engagement score (higher = better)</option>
                </select>
            </div>
            <div class="chart-wrapper"><canvas id="metricChart"></canvas></div>
        </div>

        <footer><p>&copy; 2026 Shelford Group | Data updated February 2026</p></footer>
    </div>

    <script>
        const trustData = [
            { name: 'Birmingham', rtt: 61.5, ae: 61.1, cancer: 68.6 },
            { name: 'Cambridge', rtt: 59.5, ae: 67.9, cancer: 74.0 },
            { name: 'GSTT', rtt: 66.3, ae: 76.1, cancer: 63.6 },
            { name: 'Imperial', rtt: 64.2, ae: 75.5, cancer: 70.6 },
            { name: "King's", rtt: 63.9, ae: 67.5, cancer: 65.2 },
            { name: 'Manchester', rtt: 56.1, ae: 71.6, cancer: 73.3 },
            { name: 'Newcastle', rtt: 71.4, ae: 75.9, cancer: 73.4 },
            { name: 'Oxford', rtt: 59.9, ae: 77.6, cancer: 67.5 },
            { name: 'Sheffield', rtt: 66.0, ae: 67.4, cancer: 50.5 },
            { name: 'UCLH', rtt: 59.2, ae: 69.1, cancer: 76.7 }
        ];

        let currentSortField = 'alpha';
        let currentSortDesc = true;

        function sortTable(field) {
            if (field === currentSortField && field !== 'alpha') {
                currentSortDesc = !currentSortDesc;
            } else {
                currentSortDesc = true;
            }
            currentSortField = field;
            let sorted = [...trustData];
            if (field !== 'alpha') {
                sorted.sort((a, b) => currentSortDesc ? b[field] - a[field] : a[field] - b[field]);
            }
            renderTable(sorted);
            updateSortButtons(field);
        }

        function renderTable(data) {
            document.getElementById('performanceTableBody').innerHTML = data.map(t => `
                <tr><td class="trust-name">${t.name}</td><td>${t.ae}%</td><td>${t.rtt}%</td><td>${t.cancer}%</td></tr>
            `).join('');
        }

        function updateSortButtons(activeField) {
            const fields = ['alpha', 'ae', 'rtt', 'cancer'];
            document.querySelectorAll('.sort-btn').forEach((btn, i) => {
                btn.classList.toggle('active', fields[i] === activeField);
                const arrow = btn.querySelector('.sort-arrow');
                if (arrow) arrow.textContent = (fields[i] === activeField && !currentSortDesc) ? '▲' : '▼';
            });
        }

        renderTable(trustData);

        // ===== NOF Domain Heatmap =====
        const nofData = [
            { name: 'Birmingham', overall: 4, access: 3, effectiveness: 4, finance: 4, safety: 4, people: 4 },
            { name: 'Cambridge', overall: 3, access: 4, effectiveness: 3, finance: 1, safety: 2, people: 1 },
            { name: 'GSTT', overall: 1, access: 2, effectiveness: 1, finance: 1, safety: 1, people: 1 },
            { name: 'Imperial', overall: 1, access: 1, effectiveness: 2, finance: 2, safety: 2, people: 1 },
            { name: "King's", overall: 3, access: 3, effectiveness: 3, finance: 2, safety: 4, people: 3 },
            { name: 'Manchester', overall: 3, access: 4, effectiveness: 1, finance: 2, safety: 2, people: 4 },
            { name: 'Newcastle', overall: 2, access: 2, effectiveness: 1, finance: 1, safety: 4, people: 3 },
            { name: 'Oxford', overall: 3, access: 3, effectiveness: 2, finance: 3, safety: 3, people: 1 },
            { name: 'Sheffield', overall: 2, access: 3, effectiveness: 4, finance: 1, safety: 2, people: 2 },
            { name: 'UCLH', overall: 1, access: 2, effectiveness: 1, finance: 1, safety: 2, people: 1 }
        ];
        const hmBody = document.querySelector('#heatmapTable tbody');
        const hmFields = ['overall','access','effectiveness','finance','safety','people'];
        let hmSortField = 'alpha';
        let hmSortAsc = true; // true = best first (1 before 4)

        function renderHeatmap(data) {
            hmBody.innerHTML = data.map(t => `<tr><td class="trust-name">${t.name}</td>${
                hmFields.map(d => `<td class="hm-${t[d]}">${t[d]}</td>`).join('')
            }</tr>`).join('');
        }

        function sortHeatmap(field) {
            if (field === hmSortField && field !== 'alpha') {
                hmSortAsc = !hmSortAsc;
            } else {
                hmSortAsc = true;
                hmSortField = field;
            }
            let sorted = [...nofData];
            if (field !== 'alpha') {
                sorted.sort((a, b) => hmSortAsc ? a[field] - b[field] : b[field] - a[field]);
            }
            renderHeatmap(sorted);
            // Update button states
            document.querySelectorAll('#hmSortBtns .sort-btn').forEach(btn => {
                const btnField = btn.textContent.trim().split(' ')[0].toLowerCase();
                const isActive = (field === 'alpha' && btnField === 'a-z') || btnField === field;
                btn.classList.toggle('active', isActive);
                const arrow = btn.querySelector('.sort-arrow');
                if (arrow) arrow.textContent = (isActive && !hmSortAsc) ? '▲' : '▼';
            });
        }
        renderHeatmap(nofData);

        // ===== Radar Chart =====
        const nofScores = [
            { name: 'Birmingham', scores: [2.64, 2.75, 2.94, 3.48, 3.31] },
            { name: 'Cambridge', scores: [2.91, 2.47, 1.34, 2.18, 1.56] },
            { name: 'GSTT', scores: [2.00, 1.78, 1.10, 1.85, 1.49] },
            { name: 'Imperial', scores: [1.63, 1.91, 1.74, 2.16, 1.69] },
            { name: "King's", scores: [2.66, 2.34, 1.86, 3.38, 2.61] },
            { name: 'Manchester', scores: [2.85, 1.86, 1.79, 2.37, 3.09] },
            { name: 'Newcastle', scores: [1.98, 1.85, 1.58, 3.02, 2.90] },
            { name: 'Oxford', scores: [2.40, 2.03, 2.19, 2.84, 1.67] },
            { name: 'Sheffield', scores: [2.39, 2.74, 1.00, 2.39, 2.53] },
            { name: 'UCLH', scores: [2.06, 1.46, 1.38, 2.20, 1.34] }
        ];
        const radarLabels = ['Access', 'Effectiveness', 'Finance', 'Safety', 'People'];
        const radarColors = ['#007B7F','#059669','#2563EB','#7C3AED','#DB2777','#EA580C','#0891B2','#4F46E5','#CA8A04','#DC2626'];
        let radarActive = new Set([0, 2, 9]); // Birmingham, GSTT, UCLH by default

        const radarBtnContainer = document.getElementById('radarBtns');
        nofScores.forEach((t, i) => {
            const btn = document.createElement('button');
            btn.className = 'radar-btn' + (radarActive.has(i) ? ' active' : '');
            btn.textContent = t.name;
            btn.style.borderColor = radarActive.has(i) ? radarColors[i] : '#CBD5E1';
            btn.onclick = () => {
                if (radarActive.has(i)) radarActive.delete(i); else radarActive.add(i);
                btn.classList.toggle('active');
                btn.style.borderColor = radarActive.has(i) ? radarColors[i] : '#CBD5E1';
                updateRadar();
            };
            radarBtnContainer.appendChild(btn);
        });

        const radarChart = new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: { labels: radarLabels, datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { r: { min: 1, max: 4, ticks: { stepSize: 1, callback: v => v.toFixed(0) }, pointLabels: { font: { size: 13, weight: '600' } }, reverse: true } },
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
            }
        });
        function updateRadar() {
            radarChart.data.datasets = [...radarActive].sort().map(i => ({
                label: nofScores[i].name, data: nofScores[i].scores,
                borderColor: radarColors[i], backgroundColor: radarColors[i] + '20',
                borderWidth: 2, pointRadius: 4
            }));
            radarChart.update();
        }
        updateRadar();

        // ===== Key Metrics vs National Benchmarks =====
        const metricData = {
            rtt18: { label: 'RTT 18-week %', higherBetter: true, median: 61.18, lq: 57.82, uq: 65.21,
                values: { Birmingham: 58.99, Cambridge: 58.86, GSTT: 65.21, Imperial: 62.02, "King's": 61.55, Manchester: 53.78, Newcastle: 73.24, Oxford: 59.65, Sheffield: 66.04, UCLH: 58.54 }},
            ae4hr: { label: 'A&E 4-hour %', higherBetter: true, median: 75.70, lq: 71.65, uq: 79.10,
                values: { Birmingham: 71.4, Cambridge: 73.5, GSTT: 78.2, Imperial: 81.0, "King's": 79.3, Manchester: 72.4, Newcastle: 78.3, Oxford: 82.8, Sheffield: 71.5, UCLH: 77.9 }},
            ae12hr: { label: 'A&E 12-hour %', higherBetter: false, median: 8.61, lq: 4.91, uq: 12.35,
                values: { Birmingham: 13.58, Cambridge: 10.14, GSTT: 1.39, Imperial: 7.03, "King's": 11.50, Manchester: 4.24, Newcastle: 1.86, Oxford: 0.91, Sheffield: 7.08, UCLH: 3.02 }},
            cancer62: { label: 'Cancer 62-day %', higherBetter: true, median: 69.28, lq: 64.93, uq: 75.92,
                values: { Birmingham: 62.82, Cambridge: 69.34, GSTT: 56.17, Imperial: 70.14, "King's": 60.87, Manchester: 62.16, Newcastle: 70.54, Oxford: 59.14, Sheffield: 50.86, UCLH: 78.29 }},
            cancerfds: { label: 'Cancer FDS 28-day %', higherBetter: true, median: 76.04, lq: 72.63, uq: 80.19,
                values: { Birmingham: 74.61, Cambridge: 72.43, GSTT: 82.84, Imperial: 81.47, "King's": 73.13, Manchester: 73.50, Newcastle: 71.68, Oxford: 79.79, Sheffield: 70.14, UCLH: 84.38 }},
            sickness: { label: 'Sickness absence %', higherBetter: false, median: 5.21, lq: 4.60, uq: 5.77,
                values: { Birmingham: 6.24, Cambridge: 4.56, GSTT: 4.86, Imperial: 5.12, "King's": 4.57, Manchester: 6.33, Newcastle: 6.32, Oxford: 4.43, Sheffield: 5.83, UCLH: 4.39 }},
            engagement: { label: 'Staff engagement', higherBetter: true, median: 6.88, lq: 6.71, uq: 7.04,
                values: { Birmingham: 6.62, Cambridge: 7.02, GSTT: 7.15, Imperial: 7.11, "King's": 6.58, Manchester: 6.79, Newcastle: 6.83, Oxford: 6.98, Sheffield: 6.79, UCLH: 7.35 }}
        };

        const metricChart = new Chart(document.getElementById('metricChart'), {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.raw !== null ? ctx.raw.toFixed(2) : 'N/A' } } },
                scales: { x: { title: { display: true, text: '' } } }
            },
            plugins: [{
                id: 'quartileBands',
                beforeDraw(chart) {
                    const ctx = chart.ctx, xScale = chart.scales.x, area = chart.chartArea;
                    const sel = document.getElementById('metricSelector').value;
                    const m = metricData[sel];
                    if (!m) return;
                    const lqX = xScale.getPixelForValue(m.lq), medX = xScale.getPixelForValue(m.median), uqX = xScale.getPixelForValue(m.uq);
                    ctx.save();
                    // LQ-UQ band
                    ctx.fillStyle = 'rgba(0,123,127,0.06)';
                    ctx.fillRect(lqX, area.top, uqX - lqX, area.bottom - area.top);
                    // Median line
                    ctx.strokeStyle = '#007B7F'; ctx.lineWidth = 2; ctx.setLineDash([6,4]);
                    ctx.beginPath(); ctx.moveTo(medX, area.top); ctx.lineTo(medX, area.bottom); ctx.stroke();
                    // LQ line
                    ctx.strokeStyle = '#9CA3AF'; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
                    ctx.beginPath(); ctx.moveTo(lqX, area.top); ctx.lineTo(lqX, area.bottom); ctx.stroke();
                    // UQ line
                    ctx.beginPath(); ctx.moveTo(uqX, area.top); ctx.lineTo(uqX, area.bottom); ctx.stroke();
                    // Labels
                    ctx.font = '10px -apple-system, sans-serif'; ctx.setLineDash([]);
                    ctx.fillStyle = '#9CA3AF'; ctx.fillText('LQ: ' + m.lq, lqX + 3, area.top + 12);
                    ctx.fillStyle = '#007B7F'; ctx.fillText('Median: ' + m.median, medX + 3, area.top + 12);
                    ctx.fillStyle = '#9CA3AF'; ctx.fillText('UQ: ' + m.uq, uqX + 3, area.top + 12);
                    ctx.restore();
                }
            }]
        });

        function updateMetricChart() {
            const sel = document.getElementById('metricSelector').value;
            const m = metricData[sel];
            const trusts = Object.keys(m.values);
            const vals = trusts.map(t => m.values[t]);
            // Sort: if higher is better, sort descending; if lower is better, sort ascending
            const indices = trusts.map((_, i) => i);
            if (m.higherBetter) indices.sort((a, b) => (vals[b] || 0) - (vals[a] || 0));
            else indices.sort((a, b) => (vals[a] || 999) - (vals[b] || 999));

            const sortedTrusts = indices.map(i => trusts[i]);
            const sortedVals = indices.map(i => vals[i]);
            const colors = sortedVals.map(v => {
                if (v === null) return '#CBD5E1';
                if (m.higherBetter) return '#007B7F';
                else return '#007B7F';
            });
            metricChart.data.labels = sortedTrusts;
            metricChart.data.datasets = [{ data: sortedVals, backgroundColor: colors, borderRadius: 4 }];
            metricChart.options.scales.x.title.text = m.label;
            metricChart.update();
        }
        updateMetricChart();
    </script>
</body>
</html>
